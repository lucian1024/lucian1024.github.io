---
layout: post
title:  "Flutter引擎编译和调试"
date:   2023-09-09 11:00:00 +0800
categories: [Flutter, Engine] 
tags: [Flutter]
---
## 1 概述
本文将主要介绍Flutter引擎源码获取，编译，开发环境搭建和调试。
## 2 源码获取
### 2.1 环境准备
参考Flutter官方指引[Setting up the Engine development environment](https://github.com/flutter/flutter/wiki/Setting-up-the-Engine-development-environment), 主要配置好git和depot_tools。
### 2.2 下载源码
Flutter的源码分为两个部分:  
(1) Framework层：flutter/flutter，为开发者提供各种UI组件和接口，主要是dart代码。  
(2) Engine层：flutter/engine，负责Flutter的渲染以及宿主平台的交互。  
首先新建一个源码目录, 如flutter_engine。  
Framework层的代码可以通过git从Github直接下载  

```
~/flutter_engine$ git clone https://github.com/flutter/flutter.git
```
Engine层代码需通过gclient工具获取，gclient工具在depot_tools时中，将depot_tools目录配置到系统Path中就可直接使用。
在源码目录下创建.gclient文件，内容如下

```
solutions = [
  {
    "managed": False,
    "name": "src/flutter",
    "url": "https://github.com/flutter/engine.git",
    "custom_deps": {},
    "deps_file": "DEPS",
    "safesync_url": "",
  },
]
```

然后再执行以下命令下载引擎代码，引擎代码下载耗时较长  

```
~/flutter_engine$ gclient sync
```
下载完成后flutter_engine目录下有两个子目录flutter和src，分别存放Framework和Engine的代码。  
```
~/flutter_engine$ tree -L 1       
.
├── flutter #Framework代码
└── src # Engine代码
```
Flutter引擎的版本管理规则如下：
- stable是当前的稳定分支，也即发布分支
- master包含最新的特性，但是不稳定
- 每个版本会打上对应的tag  

Framework的版本和Engine的版本是一一对应的, 在Framework代码的bin/internal/engine.version文件中可以看到当前Framework对应的Engine版本  
要切换到特定版本的代码，首先切换Framework的代码，如切换到3.13.0, 在flutter目录下执行
```
~/flutter_engine/flutter$ git checkout 3.13.0
```
然后查看bin/internal/engine.version引擎的版本(commit-id: 1ac611c64eadbd93c5f5aba5494b8fc3b35ee952), 到src/flutter目录下执行

```
~/flutter_engine/src/flutter$ git reset --hard 1ac611c64eadbd93c5f5aba5494b8fc3b35ee952
```
由于引擎的版本发生了变化，某些依赖的版本可能有更改，所以需要再次sync一下

```
~/flutter_engine/src/flutter$ gclient sync --with_branch_heads --with_tag
```
## 3 编译Flutter引擎



## 4 开发环境搭建和调试
### 4.1 源码阅读环境

### 4.2 源码调试


## 参考资料
[1] Flutter内核源码剖析